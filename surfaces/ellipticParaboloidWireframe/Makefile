################################################################################
#                                   LICENSE                                    #
################################################################################
#   This file is part of threejs_figures.                                      #
#                                                                              #
#   threejs_figures is free software: you can redistribute it and/or modify    #
#   it under the terms of the GNU General Public License as published by       #
#   the Free Software Foundation, either version 3 of the License, or          #
#   (at your option) any later version.                                        #
#                                                                              #
#   threejs_figures is distributed in the hope that it will be useful,         #
#   but WITHOUT ANY WARRANTY; without even the implied warranty of             #
#   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the              #
#   GNU General Public License for more details.                               #
#                                                                              #
#   You should have received a copy of the GNU General Public License          #
#   along with threejs_figures.  If not, see <https://www.gnu.org/licenses/>.  #
################################################################################
#   Author:     Ryan Maguire                                                   #
#   Date:       October 30, 2025                                               #
################################################################################

# Location of the threetools library.
COMMON_DIR = ../../common/csrc
THREETOOLS = libthreetools.a

# C Compilation settings
CXX = em++
CFLAGS = -Wall -Wextra -Wpedantic -I$(COMMON_DIR) -O3 -flto
LFLAGS = -L$(COMMON_DIR) \
	-Wl,--whole-archive \
	-l:$(THREETOOLS) \
	-Wl,--no-whole-archive \
	-lembind

# Location of the C++ code.
CXXSRC = $(wildcard ./csrc/*.cpp)

# Location of the optional JavaScript code. C / C++ is used by default.
JS_SRC_DIR = jssrc

# Location of the optional Rust code. C / C++ is used by default.
RUST_SRC_DIR = rustsrc
RUST_PKG_DIR = pkg
RUST_TARGET_DIR = target

# Location of the optional Go code.
GOSRC = gosrc

# Required flags for compiling Go to WebAssembly.
GO_FLAGS = GOOS=js GOARCH=wasm

# JavaScript output files generated by emscripten.
MAIN_FILE = main.js
WASM_FILE = main.wasm

# Functions exported by emscripten.
FUNCTIONS = "[               \
    '_index_buffer_address', \
    '_mesh_buffer_address',  \
    '_z_rotate_main_canvas', \
    '_set_rotation_angle'    \
]"

# Emscripten flags used for exporting the functions into a JavaScript module.
JS_FLAGS = -s MODULARIZE=1 -s EXPORT_ES6=1 -s EXPORT_NAME=createModule
EXPORT_FUNCS = -s EXPORTED_FUNCTIONS=$(FUNCTIONS)
EXPORT_METHODS = -s EXPORTED_RUNTIME_METHODS='["HEAP8"]'
EXPORTS = $(EXPORT_FUNCS) $(EXPORT_METHODS)
EMSCRIPTEN_FLAGS = $(JS_FLAGS) $(EXPORTS)

.PHONY: all clean js rust go

all: $(MAIN_FILE) $(WASM_FILE)

$(COMMON_DIR)/$(THREETOOLS):
	$(MAKE) -C $(COMMON_DIR)

$(MAIN_FILE) $(WASM_FILE): $(CXXSRC) $(COMMON_DIR)/$(THREETOOLS)
	@echo "Building main.js and main.wasm ..."
	@$(CXX) $(CFLAGS) $(CXXSRC) -o $(MAIN_FILE) $(LFLAGS) $(EMSCRIPTEN_FLAGS)

js:
	cp $(JS_SRC_DIR)/$(MAIN_FILE) .

rust:
	wasm-pack build --target web
	cp $(RUST_SRC_DIR)/$(MAIN_FILE) .

go:
	cd $(GOSRC); go mod tidy; $(GO_FLAGS) go build -o $(WASM_FILE) .
	mv $(GOSRC)/$(WASM_FILE) .

clean:
	rm -rf $(BUILD_DIR) $(RUST_PKG_DIR) $(RUST_TARGET_DIR)
	rm -f $(MAIN_FILE) $(WASM_FILE)
