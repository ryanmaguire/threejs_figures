################################################################################
#                                   LICENSE                                    #
################################################################################
#   This file is part of threejs_figures.                                      #
#                                                                              #
#   threejs_figures is free software: you can redistribute it and/or modify    #
#   it under the terms of the GNU General Public License as published by       #
#   the Free Software Foundation, either version 3 of the License, or          #
#   (at your option) any later version.                                        #
#                                                                              #
#   threejs_figures is distributed in the hope that it will be useful,         #
#   but WITHOUT ANY WARRANTY; without even the implied warranty of             #
#   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the              #
#   GNU General Public License for more details.                               #
#                                                                              #
#   You should have received a copy of the GNU General Public License          #
#   along with threejs_figures.  If not, see <https://www.gnu.org/licenses/>.  #
################################################################################
#   Author:     Ryan Maguire                                                   #
#   Date:       October 30, 2025                                               #
################################################################################

# C Compilation settings
CC = emcc
CFLAGS = -Wall -Wextra -Wpedantic -O3 -flto

# Location of the C code, and the build directory for C code.
SRC_DIR = csrc
BUILD_DIR = cbuild

# Find all C source files
SRCS = $(wildcard $(SRC_DIR)/*.c)
OBJS = $(patsubst $(SRC_DIR)/%.c,$(BUILD_DIR)/%.o,$(SRCS))

# Alias file for renaming functions to camelCase for use in JavaScript.
ALIAS_FILE = $(SRC_DIR)/alias.js

# JavaScript output files generated by emscripten.
MAIN_FILE = main.js
WASM_FILE = main.wasm

# Functions exported by emscripten.
FUNCTIONS = "[            \
    '_rotate_mesh',       \
	'_generate_indices',  \
    '_generate_mesh',     \
    '_get_index_buffer',  \
    '_get_mesh_buffer',   \
    '_set_rotation_angle' \
]"

# Emscripten flags used for exporting the functions into a JavaScript module.
JS_FLAGS = -s MODULARIZE=1 -s EXPORT_ES6=1 -s EXPORT_NAME=createModule
EXPORTS = -s EXPORTED_FUNCTIONS=$(FUNCTIONS)
POST_JS = --post-js $(ALIAS_FILE)
EMSCRIPTEN_FLAGS = $(JS_FLAGS) $(EXPORTS) $(POST_JS)

.PHONY: all clean

all: $(MAIN_FILE) $(WASM_FILE)

$(BUILD_DIR)/%.o: $(SRC_DIR)/%.c
	@mkdir -p $(BUILD_DIR)
	$(CC) $(CFLAGS) $< -c -o $@

$(MAIN_FILE) $(WASM_FILE): $(OBJS) $(ALIAS_FILE)
	$(CC) $(CFLAGS) $(OBJS) -o $(MAIN_FILE) $(EMSCRIPTEN_FLAGS)

clean:
	rm -rf $(BUILD_DIR)
	rm -f $(MAIN_FILE) $(WASM_FILE)
